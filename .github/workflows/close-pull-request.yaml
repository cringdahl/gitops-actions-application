name: Close App Pull Request

# Fetch email address of user triggering this action
# Trigger manifest repo PR closure (this includes the fetched email address)
# Delete all 'pr-##' images that aren't also tagged as releases

on:
  pull_request:
    types: [ closed ]
    paths: ['**.js', '**.json' , 'public/**', 'views/**', 'Dockerfile']
env:
  APPNAME: example-app

jobs:
  close-manifest-pr:
    runs-on: ubuntu-latest
    steps:
    - name: Get email associated with Github username
      uses: cringdahl/get-github-email-by-username@v1
      id: get-email
      with: 
        github_username: ${{ github.actor }}
    - name: Trigger close PR workflow in the manifests repository
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.MANIFEST_PAT }} # Secret auths to manifest repo
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: '${{ github.repository_owner }}',
            repo: 'gitops-actions-manifests',
            workflow_id: 'close-pull-request.yaml',
            ref: 'main',
            inputs: {
              appname: '${{ env.APPNAME }}',
              actor: '${{ github.actor }}  <${{ steps.get-email.outputs.address }}>',
              head_pr: '${{ github.event.number }}',
              merged: ${{ github.event.pull_request.merged }}
            }
          })
  # prune-pr-images:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - name: Prune images for PR-${{ github.event.number }}
  #     uses: vlaurin/action-ghcr-prune@v0.6.0
  #     with:
  #       token: ${{ github.token }}
  #       organization: cringdahl
  #       container: example-app
  #       dry-run: false
  #       prune-untagged: true
  #       keep-tags-regexes: |
  #         ^[0-9]+.[0-9]+.[0-9]+$
  #       prune-tags-regexes: |
  #         ^pr-${{ github.event.number }}